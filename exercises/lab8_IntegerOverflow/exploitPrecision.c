#include <stdio.h>
#include <string.h>

void dump_stack(void **stack, size_t n, void **arg0) {
    printf("Stack dump (stack at %p, len %d, arg0 at %p): \n", stack, n, arg0);
    //if the buffer if not aligned on a dword boundary - force alignment of print
    void** alignedStack = (void**)(((unsigned int)stack >> 2) << 2);
    while (n-- > 0) {
        printf("0x%08x: 0x%08x", (unsigned int)&alignedStack[n], (unsigned int)alignedStack[n]);
        if (n == 0) {
            printf(" (beginning of buffer)");
        }
        if (&alignedStack[n] == arg0 + 1) {
            printf(" (second argument)");
        }
        if (&alignedStack[n] == arg0) {
            printf(" (first argument)");
        }
        if (&alignedStack[n] == arg0 - 1) {
            printf(" (saved eip)");
        }
        if (&alignedStack[n] == arg0 - 2) {
            printf(" (saved ebp)");
        }
        printf("\n");
    }
}

int checkSize(size_t arraySize, unsigned short len){
    printf("len = %d\n", len);
    if(len >= arraySize){            /* [w1] */
            return -1;
    }
    return 0;
}


int main(int argc, char *argv[]){
    char buf[20];
    int i;

    if(argc < 3){
	printf("Usage: exploitPrecision <length> <string>\n");
        return -1;
    }
 
   i = atoi(argv[1]);

    if(0 != checkSize(sizeof(buf), i)){
        printf("Oh no you don't!\n");
	return -1;
    }

    dump_stack((void **) buf, 20, (void **) &argc);

    memcpy(buf, argv[2], i);
 
    printf("After memcpy\n");
    dump_stack((void **) buf, 20, (void **) &argc);

    buf[i] = '\0';
    printf("%s\n", buf);

    return 0;
}
